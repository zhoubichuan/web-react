<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/web-react/umi.86614d3c.css" />
    <script>
      window.routerBase = "/web-react/";
    </script>
    <script>
      //! umi version: 3.5.32
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>react-reconciler - web-react</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/3.source/2.react-dom/react-reconciler" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/web-react//">web-react</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/web-react//1.base">基础知识</a></span><span><a href="/web-react//2.senior">高级知识</a></span><span><a aria-current="page" class="active" href="/web-react//3.source">源码知识</a></span><span><a href="/web-react//4.read">阅读资料</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhoubichuan/web-react">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/web-react//"></a><h1>web-react</h1><p>react 学习笔记</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/web-react//1.base">基础知识</a></li><li><a href="/web-react//2.senior">高级知识</a></li><li><a aria-current="page" class="active" href="/web-react//3.source">源码知识</a></li><li><a href="/web-react//4.read">阅读资料</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhoubichuan/web-react">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/web-react//3.source/1.react/preparation">react</a></li><li><a target="_blank" rel="noopener noreferrer">react-dom</a><ul><li><a href="/web-react//3.source/2.react-dom/preparation"><span>源码概览</span></a></li><li><a href="/web-react//3.source/2.react-dom/react-root"><span>创建root</span></a></li><li><a href="/web-react//3.source/2.react-dom/root"><span>创建root（fiber节点）</span></a></li><li><a href="/web-react//3.source/2.react-dom/expiration-time"><span>创建root（优先级）</span></a></li><li><a href="/web-react//3.source/2.react-dom/update-queue"><span>创建 root（更新队列）</span></a></li><li><a href="/web-react//3.source/2.react-dom/render-root"><span>渲染 root</span></a></li><li><a href="/web-react//3.source/2.react-dom/create-work-in-progress"><span>创建root</span></a></li><li><a href="/web-react//3.source/2.react-dom/work-loop"><span>渲染 root（workLoop）</span></a></li><li><a href="/web-react//3.source/2.react-dom/on-complete"><span>渲染 root（onComplete）</span></a></li><li><a href="/web-react//3.source/2.react-dom/commit-root"><span>提交 root</span></a></li><li><a href="/web-react//3.source/2.react-dom/lcommit-before-mutation-lifecycles"><span>提交 root（dom 更新前）</span></a></li><li><a href="/web-react//3.source/2.react-dom/commit-all-host-effects"><span>提交 root（dom 更新中）</span></a></li><li><a href="/web-react//3.source/2.react-dom/lcommit-all-life-cycles"><span>提交 root（dom 更新后）</span></a></li><li><a aria-current="page" class="active" href="/web-react//3.source/2.react-dom/react-reconciler"><span>react-reconciler</span></a></li></ul></li><li><a href="/web-react//3.source/3.react-router/1">react-router</a></li><li><a href="/web-react//3.source/4.redux/1">redux</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="updateContainer" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#updatecontainer"><span>updateContainer</span></a></li><li title="requestCurrentTime" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#requestcurrenttime"><span>requestCurrentTime</span></a></li><li title="computeExpirationForFiber" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#computeexpirationforfiber"><span>computeExpirationForFiber</span></a></li><li title="updateContainerAtExpirationTime" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#updatecontaineratexpirationtime"><span>updateContainerAtExpirationTime</span></a></li><li title="scheduleRootUpdate" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#schedulerootupdate"><span>scheduleRootUpdate</span></a></li><li title="scheduleWork" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#schedulework"><span>scheduleWork</span></a></li><li title="resetStack" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#resetstack"><span>resetStack</span></a></li><li title="unwindInterruptedWork" data-depth="3"><a href="/web-react//3.source/2.react-dom/react-reconciler#unwindinterruptedwork"><span>unwindInterruptedWork</span></a></li><li title="requestWork" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#requestwork"><span>requestWork</span></a></li><li title="addRootToSchedule" data-depth="3"><a href="/web-react//3.source/2.react-dom/react-reconciler#addroottoschedule"><span>addRootToSchedule</span></a></li><li title="performSyncWork" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#performsyncwork"><span>performSyncWork</span></a></li><li title="scheduleCallbackWithExpirationTime" data-depth="3"><a href="/web-react//3.source/2.react-dom/react-reconciler#schedulecallbackwithexpirationtime"><span>scheduleCallbackWithExpirationTime</span></a></li><li title="performWork" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#performwork"><span>performWork</span></a></li><li title="performWorkOnRoot" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#performworkonroot"><span>performWorkOnRoot</span></a></li><li title="renderRoot" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#renderroot"><span>renderRoot</span></a></li><li title="workLoop" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#workloop"><span>workLoop</span></a></li><li title="performUnitOfWork" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#performunitofwork"><span>performUnitOfWork</span></a></li><li title="beginWork" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#beginwork"><span>beginWork</span></a></li><li title="mountIndeterminateComponent" data-depth="2"><a href="/web-react//3.source/2.react-dom/react-reconciler#mountindeterminatecomponent"><span>mountIndeterminateComponent</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="react-reconciler"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#react-reconciler"><span class="icon icon-link"></span></a>react-reconciler</h1><h2 id="updatecontainer"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#updatecontainer"><span class="icon icon-link"></span></a>updateContainer</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter literal-property property">element</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">OpaqueRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">parentComponent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter maybe-class-name">React$Component</span><span class="token parameter operator">&lt;</span><span class="token parameter">any</span><span class="token parameter punctuation">,</span><span class="token parameter"> any</span><span class="token parameter operator">&gt;</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">callback</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter known-class-name class-name">Function</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExpirationTime</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> currentTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> expirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span><span class="token plain">currentTime</span><span class="token punctuation">,</span><span class="token plain"> current</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    element</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    parentComponent</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    expirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    callback</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="requestcurrenttime"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#requestcurrenttime"><span class="icon icon-link"></span></a>requestCurrentTime</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isRendering</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> currentSchedulerTime</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextFlushedExpirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextFlushedExpirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Never</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    currentSchedulerTime </span><span class="token operator">=</span><span class="token plain"> currentRendererTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> currentSchedulerTime</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> currentSchedulerTime</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="computeexpirationforfiber"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#computeexpirationforfiber"><span class="icon icon-link"></span></a>computeExpirationForFiber</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span><span class="token parameter literal-property property">currentTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">fiber</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> expirationTime </span><span class="token comment">//优先级</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">expirationContext </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    expirationTime </span><span class="token operator">=</span><span class="token plain"> expirationContext</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isWorking</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isCommitting</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      expirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Sync</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      expirationTime </span><span class="token operator">=</span><span class="token plain"> nextRenderExpirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">ConcurrentMode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isBatchingInteractiveUpdates</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        expirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">computeInteractiveExpiration</span><span class="token punctuation">(</span><span class="token plain">currentTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//高优先级更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        expirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">computeAsyncExpiration</span><span class="token punctuation">(</span><span class="token plain">currentTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//低优先级更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextRoot </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> expirationTime </span><span class="token operator">===</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        expirationTime </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      expirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Sync</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isBatchingInteractiveUpdates</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">expirationTime </span><span class="token operator">&gt;</span><span class="token plain"> lowestPriorityPendingInteractiveExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      lowestPriorityPendingInteractiveExpirationTime </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="updatecontaineratexpirationtime"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#updatecontaineratexpirationtime"><span class="icon icon-link"></span></a>updateContainerAtExpirationTime</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter literal-property property">element</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">OpaqueRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">parentComponent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter maybe-class-name">React$Component</span><span class="token parameter operator">&lt;</span><span class="token parameter">any</span><span class="token parameter punctuation">,</span><span class="token parameter"> any</span><span class="token parameter operator">&gt;</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">expirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">callback</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter known-class-name class-name">Function</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getContextForSubtree</span><span class="token punctuation">(</span><span class="token plain">parentComponent</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">.</span><span class="token property-access">context</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">.</span><span class="token property-access">context</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> context</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">.</span><span class="token property-access">pendingContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> context</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> element</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="schedulerootupdate"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#schedulerootupdate"><span class="icon icon-link"></span></a>scheduleRootUpdate</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">element</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">expirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">callback</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter known-class-name class-name">Function</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token plain">expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  update</span><span class="token punctuation">.</span><span class="token property-access">payload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> element </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  callback </span><span class="token operator">=</span><span class="token plain"> callback </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> callback</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">callback </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> callback</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> update</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">scheduleWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="schedulework"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#schedulework"><span class="icon icon-link"></span></a>scheduleWork</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">scheduleWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">fiber</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">expirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//1.找到更新对应的FiberRoot节点，按照树的结构通过fiber.return一层层的返回，直到找到根节点。在向上找的过程中不断的更新每个节点对应的fiber对象childExpirationTime。并且alternate同步更新。</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">root </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token operator">!</span><span class="token plain">isWorking </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextRenderExpirationTime </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    expirationTime </span><span class="token operator">&lt;</span><span class="token plain"> nextRenderExpirationTime</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//发现当前更新的优先级高于上一个任务，则重置stack，回退任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    interruptedBy </span><span class="token operator">=</span><span class="token plain"> fiber</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">markPendingPriorityLevel</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">isWorking </span><span class="token operator">||</span><span class="token plain"> isCommitting </span><span class="token operator">||</span><span class="token plain"> nextRoot </span><span class="token operator">!==</span><span class="token plain"> root</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> rootExpirationTime </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">requestWork</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> rootExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//请求调度任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nestedUpdateCount </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token constant">NESTED_UPDATE_LIMIT</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//在某些生命周期函数中setState会造成无限循环，这里是告诉你的代码触发无限循环了</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nestedUpdateCount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="resetstack"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#resetstack"><span class="icon icon-link"></span></a>resetStack</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> interruptedWork </span><span class="token operator">=</span><span class="token plain"> nextUnitOfWork</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">interruptedWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">//开始一步一步往上恢复，前一个执行的任务需要回退一步，因为现在有更高优先级的任务需要执行</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">unwindInterruptedWork</span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      interruptedWork </span><span class="token operator">=</span><span class="token plain"> interruptedWork</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  nextRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  nextRenderExpirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  nextLatestAbsoluteTimeoutMs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  nextRenderDidError </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="unwindinterruptedwork"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#unwindinterruptedwork"><span class="icon icon-link"></span></a>unwindInterruptedWork</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">unwindInterruptedWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">interruptedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> childContextTypes </span><span class="token operator">=</span><span class="token plain"> interruptedWork</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">.</span><span class="token property-access">childContextTypes</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">childContextTypes </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> childContextTypes </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">popLegacyContext</span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">popHostContainer</span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">popTopLevelLegacyContextObject</span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">popHostContext</span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostPortal</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">popHostContainer</span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ContextProvider</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">popProvider</span><span class="token punctuation">(</span><span class="token plain">interruptedWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="requestwork"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#requestwork"><span class="icon icon-link"></span></a>requestWork</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">requestWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">expirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">addRootToSchedule</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//将Root加入到Schedule（addRootToSchedule），如果此root已经调度过（已经在scheduleRoot的单向链表中），可能更新root.expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isRendering</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isBatchingUpdates</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isUnbatchingUpdates</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextFlushedRoot </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">      nextFlushedExpirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Sync</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Sync</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">expirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Sync</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//同步任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//异步任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="addroottoschedule"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#addroottoschedule"><span class="icon icon-link"></span></a>addRootToSchedule</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">addRootToSchedule</span><span class="token punctuation">(</span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">expirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">nextScheduledRoot</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lastScheduledRoot </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">//当前没有要处理的root</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      firstScheduledRoot </span><span class="token operator">=</span><span class="token plain"> lastScheduledRoot </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">.</span><span class="token property-access">nextScheduledRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      lastScheduledRoot</span><span class="token punctuation">.</span><span class="token property-access">nextScheduledRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">      lastScheduledRoot </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">      lastScheduledRoot</span><span class="token punctuation">.</span><span class="token property-access">nextScheduledRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> firstScheduledRoot</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> remainingExpirationTime </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      remainingExpirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      expirationTime </span><span class="token operator">&lt;</span><span class="token plain"> remainingExpirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="performsyncwork"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#performsyncwork"><span class="icon icon-link"></span></a>performSyncWork</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">performWork</span><span class="token punctuation">(</span><span class="token maybe-class-name">Sync</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="schedulecallbackwithexpirationtime"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#schedulecallbackwithexpirationtime"><span class="icon icon-link"></span></a>scheduleCallbackWithExpirationTime</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">expirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">callbackExpirationTime </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// 判断上一个callback是否执行完毕</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">expirationTime </span><span class="token operator">&gt;</span><span class="token plain"> callbackExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">//当前任务如果优先级小于上个任务就退出</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">callbackID </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">cancelDeferredCallback</span><span class="token punctuation">(</span><span class="token plain">callbackID</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">startRequestCallbackTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  callbackExpirationTime </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> currentMs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> originalStartTimeMs </span><span class="token comment">//当前performance.now() - 程序刚执行时的performance.now()</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> expirationTimeMs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token plain">expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//转换ms</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> timeout </span><span class="token operator">=</span><span class="token plain"> expirationTimeMs </span><span class="token operator">-</span><span class="token plain"> currentMs </span><span class="token comment">//当前任务的延迟过期时间，由过期时间 - 当前任务创建时间 = 超过时代表任务过期需要强制更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callbackID </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">scheduleDeferredCallback</span><span class="token punctuation">(</span><span class="token plain">performAsyncWork</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> timeout </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//生成一个callbackID，用于关闭任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="performwork"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#performwork"><span class="icon icon-link"></span></a>performWork</h2><p>任务执行</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">minExpirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">dl</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Deadline</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  deadline </span><span class="token operator">=</span><span class="token plain"> dl</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">deadline </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//同步任务，不考虑帧渲染是否有空余时间，同步任务也没有过期时间</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    currentSchedulerTime </span><span class="token operator">=</span><span class="token plain"> currentRendererTime</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableUserTimingAPI</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> didExpire </span><span class="token operator">=</span><span class="token plain"> nextFlushedExpirationTime </span><span class="token operator">&lt;</span><span class="token plain"> currentRendererTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> timeout </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token plain">nextFlushedExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">stopRequestCallbackTimer</span><span class="token punctuation">(</span><span class="token plain">didExpire</span><span class="token punctuation">,</span><span class="token plain"> timeout</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextFlushedRoot </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextFlushedExpirationTime </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">minExpirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        minExpirationTime </span><span class="token operator">&gt;=</span><span class="token plain"> nextFlushedExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">deadlineDidExpire </span><span class="token operator">||</span><span class="token plain"> currentRendererTime </span><span class="token operator">&gt;=</span><span class="token plain"> nextFlushedExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">//遍历所有的root，并且把所有root中同步的任务全部执行掉</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        nextFlushedRoot</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        nextFlushedExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        currentRendererTime </span><span class="token operator">&gt;=</span><span class="token plain"> nextFlushedExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">recomputeCurrentRendererTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      currentSchedulerTime </span><span class="token operator">=</span><span class="token plain"> currentRendererTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//异步任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextFlushedRoot </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextFlushedExpirationTime </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">minExpirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        minExpirationTime </span><span class="token operator">&gt;=</span><span class="token plain"> nextFlushedExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">//遍历所有root，执行完所有root中的过期任务，因为过期任务是必须要执行的。如果这一帧还有空闲时间，尽可能的执行更多任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain">nextFlushedRoot</span><span class="token punctuation">,</span><span class="token plain"> nextFlushedExpirationTime</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">deadline </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    callbackExpirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    callbackID </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFlushedExpirationTime </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">scheduleCallbackWithExpirationTime</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">nextFlushedRoot</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberRoot</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextFlushedExpirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Clean-up.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  deadline </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  deadlineDidExpire </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">finishRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="performworkonroot"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#performworkonroot"><span class="icon icon-link"></span></a>performWorkOnRoot</h2><p>执行任务的两个阶段</p><ul><li>renderRoot 渲染阶段</li><li>completeRoot 提交阶段</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">expirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">isExpired</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isRendering </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">deadline </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> isExpired</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//同步任务或者任务已经过期，不可以打断任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> finishedWork </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">//是否存在已经完成的finishedWork,存在就完成它</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">completeRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> timeoutHandle </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">timeoutHandle</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">timeoutHandle </span><span class="token operator">!==</span><span class="token plain"> noTimeout</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        root</span><span class="token punctuation">.</span><span class="token property-access">timeoutHandle</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> noTimeout</span></div><div class="token-line"><span class="token plain">        </span><span class="token function">cancelTimeout</span><span class="token punctuation">(</span><span class="token plain">timeoutHandle</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> isYieldy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">renderRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> isYieldy</span><span class="token punctuation">,</span><span class="token plain"> isExpired</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      finishedWork </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">completeRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">//异步任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> finishedWork </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">completeRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> timeoutHandle </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">timeoutHandle</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">timeoutHandle </span><span class="token operator">!==</span><span class="token plain"> noTimeout</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        root</span><span class="token punctuation">.</span><span class="token property-access">timeoutHandle</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> noTimeout</span></div><div class="token-line"><span class="token plain">        </span><span class="token function">cancelTimeout</span><span class="token punctuation">(</span><span class="token plain">timeoutHandle</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> isYieldy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token comment">//可以中断</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">renderRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> isYieldy</span><span class="token punctuation">,</span><span class="token plain"> isExpired</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      finishedWork </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">//这一帧还有空余时间，执行completeRoot</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">completeRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token comment">//没有空余时间，等下一帧</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> finishedWork</span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  isRendering </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="renderroot"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#renderroot"><span class="icon icon-link"></span></a>renderRoot</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">renderRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">isYieldy</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">isExpired</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isWorking </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentOwner</span><span class="token punctuation">.</span><span class="token property-access">currentDispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatcher</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> expirationTime </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">nextExpirationTimeToWorkOn</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    expirationTime </span><span class="token operator">!==</span><span class="token plain"> nextRenderExpirationTime </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root </span><span class="token operator">!==</span><span class="token plain"> nextRoot </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextUnitOfWork </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextRoot </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">    nextRenderExpirationTime </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">    nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createWorkInProgress</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextRoot</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextRenderExpirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root</span><span class="token punctuation">.</span><span class="token property-access">pendingCommitExpirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableSchedulerTracing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">interactions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Set</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Interaction</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">.</span><span class="token property-access">pendingInteractionMap</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">(</span><span class="token parameter">scheduledInteractions</span><span class="token parameter punctuation">,</span><span class="token parameter"> scheduledExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">scheduledExpirationTime </span><span class="token operator">&lt;=</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            scheduledInteractions</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interaction</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              interactions</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token plain">interaction</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">.</span><span class="token property-access">memoizedInteractions</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> interactions</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">interactions</span><span class="token punctuation">.</span><span class="token property-access">size</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> subscriber </span><span class="token operator">=</span><span class="token plain"> __subscriberRef</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">subscriber </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> threadID </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">computeThreadID</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            expirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            root</span><span class="token punctuation">.</span><span class="token property-access">interactionThreadID</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            subscriber</span><span class="token punctuation">.</span><span class="token method function property-access">onWorkStarted</span><span class="token punctuation">(</span><span class="token plain">interactions</span><span class="token punctuation">,</span><span class="token plain"> threadID</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">error</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">hasUnhandledError</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              hasUnhandledError </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              unhandledError </span><span class="token operator">=</span><span class="token plain"> error</span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">prevInteractions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Set</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Interaction</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableSchedulerTracing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    prevInteractions </span><span class="token operator">=</span><span class="token plain"> __interactionsRef</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    __interactionsRef</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">memoizedInteractions</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> didFatal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">startWorkLoopTimer</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token plain">isYieldy</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">thrownValue</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        didFatal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token function">onUncaughtError</span><span class="token punctuation">(</span><span class="token plain">thrownValue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">failedUnitOfWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> nextUnitOfWork</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">sourceFiber</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> nextUnitOfWork</span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">let</span><span class="token plain"> returnFiber </span><span class="token operator">=</span><span class="token plain"> sourceFiber</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">returnFiber </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          didFatal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">onUncaughtError</span><span class="token punctuation">(</span><span class="token plain">thrownValue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">throwException</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            returnFiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            sourceFiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            thrownValue</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            nextRenderExpirationTime</span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">sourceFiber</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">continue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableSchedulerTracing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// Traced work is done for now; restore the previous interactions.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    __interactionsRef</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> prevInteractions</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// We&#x27;re done performing work. Time to clean up.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isWorking </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentOwner</span><span class="token punctuation">.</span><span class="token property-access">currentDispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resetContextDependences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Yield back to main thread.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">didFatal</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> didCompleteRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">stopWorkLoopTimer</span><span class="token punctuation">(</span><span class="token plain">interruptedBy</span><span class="token punctuation">,</span><span class="token plain"> didCompleteRoot</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    interruptedBy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    nextRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">onFatal</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> didCompleteRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">stopWorkLoopTimer</span><span class="token punctuation">(</span><span class="token plain">interruptedBy</span><span class="token punctuation">,</span><span class="token plain"> didCompleteRoot</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    interruptedBy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">onYield</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// We completed the whole tree.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> didCompleteRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">stopWorkLoopTimer</span><span class="token punctuation">(</span><span class="token plain">interruptedBy</span><span class="token punctuation">,</span><span class="token plain"> didCompleteRoot</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> rootWorkInProgress </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  nextRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  interruptedBy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextRenderDidError</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// There was an error</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">hasLowerPriorityWork</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">markSuspendedPriorityLevel</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> suspendedExpirationTime </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> rootExpirationTime </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">onSuspend</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        rootWorkInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        suspendedExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        rootExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"> </span><span class="token comment">// Indicates no timeout</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">didError</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">isExpired</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">.</span><span class="token property-access">didError</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> suspendedExpirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">nextExpirationTimeToWorkOn</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> rootExpirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Sync</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">onSuspend</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        rootWorkInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        suspendedExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        rootExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"> </span><span class="token comment">// Indicates no timeout</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">isExpired </span><span class="token operator">&amp;&amp;</span><span class="token plain"> nextLatestAbsoluteTimeoutMs </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> suspendedExpirationTime </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">markSuspendedPriorityLevel</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> suspendedExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> earliestExpirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">findEarliestOutstandingPriorityLevel</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      expirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> earliestExpirationTimeMs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token plain">earliestExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">earliestExpirationTimeMs </span><span class="token operator">&lt;</span><span class="token plain"> nextLatestAbsoluteTimeoutMs</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextLatestAbsoluteTimeoutMs </span><span class="token operator">=</span><span class="token plain"> earliestExpirationTimeMs</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> currentTimeMs </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">expirationTimeToMs</span><span class="token punctuation">(</span><span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> msUntilTimeout </span><span class="token operator">=</span><span class="token plain"> nextLatestAbsoluteTimeoutMs </span><span class="token operator">-</span><span class="token plain"> currentTimeMs</span></div><div class="token-line"><span class="token plain">    msUntilTimeout </span><span class="token operator">=</span><span class="token plain"> msUntilTimeout </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> msUntilTimeout</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> rootExpirationTime </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">onSuspend</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      rootWorkInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      suspendedExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      rootExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      msUntilTimeout</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> rootWorkInProgress</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="workloop"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#workloop"><span class="icon icon-link"></span></a>workLoop</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">isYieldy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">isYieldy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="performunitofwork"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#performunitofwork"><span class="icon icon-link"></span></a>performUnitOfWork</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">startWorkTimer</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> next</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableProfilerTimer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">ProfileMode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">startProfilerTimer</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">ProfileMode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">stopProfilerTimerIfRunningAndRecordDelta</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentOwner</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> next</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="beginwork"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#beginwork"><span class="icon icon-link"></span></a>beginWork</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter literal-property property">renderExpirationTime</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ExpirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updateExpirationTime </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// ------如果满足以下条件React会判断当前节点是不需要更新的---------</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> oldProps </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token comment">//老的props</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"> </span><span class="token comment">//新的props</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      oldProps </span><span class="token operator">===</span><span class="token plain"> newProps </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token comment">// 新旧props比较</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">!</span><span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token comment">// 是否有老版本的context使用并且发生变化</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">updateExpirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        updateExpirationTime </span><span class="token operator">&gt;</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//当前节点是否需要更新以及他的更新优先级是否在当前更新优先级之前</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ------------------------------------------------------------</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">pushHostRootContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">resetHydrationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">pushHostContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isLegacyContextProvider</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token function">pushLegacyContextProvider</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostPortal</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">pushHostContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">.</span><span class="token property-access">containerInfo</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ContextProvider</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> newValue </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token function">pushProvider</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> newValue</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Profiler</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableProfilerTimer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            workInProgress</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SuspenseComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">state</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">SuspenseState</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> didTimeout </span><span class="token operator">=</span><span class="token plain"> state </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> state</span><span class="token punctuation">.</span><span class="token property-access">didTimeout</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">didTimeout</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">primaryChildFragment</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">const</span><span class="token plain"> primaryChildExpirationTime </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              primaryChildFragment</span><span class="token punctuation">.</span><span class="token property-access">childExpirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              primaryChildExpirationTime </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              primaryChildExpirationTime </span><span class="token operator">&lt;=</span><span class="token plain"> renderExpirationTime</span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateSuspenseComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                renderExpirationTime</span></div><div class="token-line"><span class="token plain">              </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword">const</span><span class="token plain"> child </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                renderExpirationTime</span></div><div class="token-line"><span class="token plain">              </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">child </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword control-flow">return</span><span class="token plain"> child</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// Before entering the begin phase, clear the expiration time.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">IndeterminateComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> elementType </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        elementType</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">LazyComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> elementType </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">mountLazyComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        elementType</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        updateExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostText</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SuspenseComponent</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateSuspenseComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostPortal</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updatePortalComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ForwardRef</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> type </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> type</span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token plain">type</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateForwardRef</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Fragment</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateFragment</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Mode</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateMode</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Profiler</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateProfiler</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ContextProvider</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateContextProvider</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ContextConsumer</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateContextConsumer</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">MemoComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> type </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token plain">type</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateMemoComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        updateExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateSimpleMemoComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        updateExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">IncompleteClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">mountIncompleteClassComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        renderExpirationTime</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h2 id="mountindeterminatecomponent"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/react-reconciler#mountindeterminatecomponent"><span class="icon icon-link"></span></a>mountIndeterminateComponent</h2><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">_current</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  workInProgress</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  </span><span class="token parameter maybe-class-name">Component</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div><div class="token-line"><span class="token parameter">  renderExpirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">_current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    _current</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Placement</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> unmaskedContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getMaskedContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> unmaskedContext</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">prepareToReadContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  value </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Component</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">,</span><span class="token plain"> context</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">PerformedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">typeof</span><span class="token plain"> value </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;object&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    value </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">typeof</span><span class="token plain"> value</span><span class="token punctuation">.</span><span class="token property-access">render</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    value</span><span class="token punctuation">.</span><span class="token property-access">$$</span><span class="token keyword">typeof</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ClassComponent</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> hasContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">isLegacyContextProvider</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      hasContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">pushLegacyContextProvider</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      hasContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      value</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> value</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> value</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> getDerivedStateFromProps </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation">.</span><span class="token property-access">getDerivedStateFromProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> getDerivedStateFromProps </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">applyDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        getDerivedStateFromProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        props</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token function">adoptClassInstance</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">mountClassInstance</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> props</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">finishClassComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      hasContext</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      renderExpirationTime</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponent</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhoubichuan/web-react/edit/master/docs/3.source/2.react-dom/reactReconciler.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">8/8/2022 09:38:12</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/web-react/umi.261db0dc.js"></script>
  </body>
</html>
