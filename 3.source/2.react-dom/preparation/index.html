<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/web-react/umi.86614d3c.css" />
    <script>
      window.routerBase = "/web-react/";
    </script>
    <script>
      //! umi version: 3.5.32
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>源码概览 - web-react</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/3.source/2.react-dom/preparation" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/web-react//">web-react</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/web-react//1.base">基础知识</a></span><span><a href="/web-react//2.senior">高级知识</a></span><span><a aria-current="page" class="active" href="/web-react//3.source">源码知识</a></span><span><a href="/web-react//4.read">阅读资料</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhoubichuan/web-react">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/web-react//"></a><h1>web-react</h1><p>react 学习笔记</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/web-react//1.base">基础知识</a></li><li><a href="/web-react//2.senior">高级知识</a></li><li><a aria-current="page" class="active" href="/web-react//3.source">源码知识</a></li><li><a href="/web-react//4.read">阅读资料</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhoubichuan/web-react">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/web-react//3.source/1.react/preparation">react</a></li><li><a target="_blank" rel="noopener noreferrer">react-dom</a><ul><li><a aria-current="page" class="active" href="/web-react//3.source/2.react-dom/preparation"><span>源码概览</span></a></li><li><a href="/web-react//3.source/2.react-dom/react-root"><span>创建root</span></a></li><li><a href="/web-react//3.source/2.react-dom/root"><span>创建root（fiber节点）</span></a></li><li><a href="/web-react//3.source/2.react-dom/expiration-time"><span>创建root（优先级）</span></a></li><li><a href="/web-react//3.source/2.react-dom/update-queue"><span>创建 root（更新队列）</span></a></li><li><a href="/web-react//3.source/2.react-dom/render-root"><span>渲染 root</span></a></li><li><a href="/web-react//3.source/2.react-dom/create-work-in-progress"><span>创建root</span></a></li><li><a href="/web-react//3.source/2.react-dom/work-loop"><span>渲染 root（workLoop）</span></a></li><li><a href="/web-react//3.source/2.react-dom/on-complete"><span>渲染 root（onComplete）</span></a></li><li><a href="/web-react//3.source/2.react-dom/commit-root"><span>提交 root</span></a></li><li><a href="/web-react//3.source/2.react-dom/lcommit-before-mutation-lifecycles"><span>提交 root（dom 更新前）</span></a></li><li><a href="/web-react//3.source/2.react-dom/commit-all-host-effects"><span>提交 root（dom 更新中）</span></a></li><li><a href="/web-react//3.source/2.react-dom/lcommit-all-life-cycles"><span>提交 root（dom 更新后）</span></a></li><li><a href="/web-react//3.source/2.react-dom/react-reconciler"><span>react-reconciler</span></a></li></ul></li><li><a href="/web-react//3.source/3.react-router/1">react-router</a></li><li><a href="/web-react//3.source/4.redux/1">redux</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="1.创建root节点" data-depth="2"><a href="/web-react//3.source/2.react-dom/preparation#1创建root节点"><span>1.创建root节点</span></a></li><li title="1.1 createFiberRoot" data-depth="3"><a href="/web-react//3.source/2.react-dom/preparation#11-createfiberroot"><span>1.1 createFiberRoot</span></a></li><li title="2.更新渲染 root 节点" data-depth="2"><a href="/web-react//3.source/2.react-dom/preparation#2更新渲染-root-节点"><span>2.更新渲染 root 节点</span></a></li><li title="2.1 创建更新" data-depth="3"><a href="/web-react//3.source/2.react-dom/preparation#21-创建更新"><span>2.1 创建更新</span></a></li><li title="2.2 将生成的更新放入更新队列" data-depth="3"><a href="/web-react//3.source/2.react-dom/preparation#22-将生成的更新放入更新队列"><span>2.2 将生成的更新放入更新队列</span></a></li><li title="2.3 中断" data-depth="3"><a href="/web-react//3.source/2.react-dom/preparation#23-中断"><span>2.3 中断</span></a></li><li title="2.4 创建子节点和兄弟节点" data-depth="3"><a href="/web-react//3.source/2.react-dom/preparation#24-创建子节点和兄弟节点"><span>2.4 创建子节点和兄弟节点</span></a></li><li title="2.5 标识更新节点" data-depth="3"><a href="/web-react//3.source/2.react-dom/preparation#25-标识更新节点"><span>2.5 标识更新节点</span></a></li><li title="2.6 commitRoot" data-depth="3"><a href="/web-react//3.source/2.react-dom/preparation#26-commitroot"><span>2.6 commitRoot</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="源码概览"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#源码概览"><span class="icon icon-link"></span></a>源码概览</h1><p><img src="/web-react/static/1.2.4a8b7b60.png" alt=""/></p><p>主要步骤：创建 root --&gt; 渲染 root --&gt; 提交 root</p><ul><li>1 ReactRoot<ul><li>1.1 通过<code>createFiberRoot</code>创建一个<code>FiberRoot</code>节点，通过<code>FiberNode</code>创建一个<code>RootFiber</code>节点，作为<code>root</code>节点相互引用</li><li>1.2 更新过期时间，给任务定义优先级</li><li>1.3 创建更新，将更新队列挂载到<code>RootFiber</code>上</li></ul></li><li>2 renderRoot<ul><li>2.1 拷贝 fiber 节点作为副本修改后，前后可以比较</li><li>2.2 循环单元更新节点</li><li>2.3 onComplete</li></ul></li><li>3 commitRoot：将更新反馈到 dom 上<ul><li>3.1 commitBeforeMutationLifecycles：遍历 effect 链、更新 state</li><li>3.2 commitAllHostEffects：遍历 effect 链，不同的 effectTag 执行不同的操作</li><li>3.3 commitAllLifeCycles：componentDidMount、componentDidUpdate、setState 回调函数、清空 commitUpdateQueue</li></ul></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain">hello</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></pre></div><p><img src="/web-react/static/1.e82aa600.png" alt=""/></p><h2 id="1创建root节点"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#1创建root节点"><span class="icon icon-link"></span></a>1.创建<code>root</code>节点</h2><p>React 首先会生成一个 root 节点，里面包含了<code>RootFiber</code>和<code>FiberRoot</code>，它们是互相引用的关系，可以通过对象找到对方</p><p><code>FiberTree</code>中根节点主要是靠<code>createFiberRoot</code>生成的，React 在 createFiberRoot 之前会做一系列的准备工作</p><blockquote><p>ReactDOM. render --&gt; legacyRenderSubtreeIntoContainer --&gt; container._reactRootContainer = legacyCreateRootFromDOMContainer = ReactRoot = DOMRenderer.createContainer = createFiberRoot</p></blockquote><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">element：</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string-property property">&quot;$$typeof&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Symbol</span><span class="token punctuation">(</span><span class="token plain">react</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string-property property">&quot;key&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string-property property">&quot;ref&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string-property property">&quot;props&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string-property property">&quot;_owner&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string-property property">&quot;_store&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token function">render</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  element</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  container</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callback</span><span class="token punctuation">,</span><span class="token comment">//undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    element</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    callback</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>legacyRenderSubtreeIntoContainer</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  parentComponent</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  children</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  container</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  forceHydrate</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callback </span><span class="token comment">// undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  container</span><span class="token punctuation">.</span><span class="token property-access">_reactRootContainer</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    forceHydrate</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token plain">children</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">DOMRenderer</span><span class="token punctuation">.</span><span class="token method function property-access">getPublicRootInstance</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>legacyCreateRootFromDOMContainer</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token parameter punctuation">,</span><span class="token parameter"> forceHydrate</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ReactRoot</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> isConcurrent</span><span class="token punctuation">,</span><span class="token plain"> shouldHydrate</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>ReactRoot</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">ReactRoot</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token parameter punctuation">,</span><span class="token parameter"> isConcurrent</span><span class="token parameter punctuation">,</span><span class="token parameter"> hydrate</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">DOMRenderer</span><span class="token punctuation">.</span><span class="token method function property-access">createContainer</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> isConcurrent</span><span class="token punctuation">,</span><span class="token plain"> hydrate</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>createContainer</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token parameter punctuation">,</span><span class="token parameter"> isConcurrent</span><span class="token parameter punctuation">,</span><span class="token parameter"> hydrate</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token plain">containerInfo</span><span class="token punctuation">,</span><span class="token plain"> isConcurrent</span><span class="token punctuation">,</span><span class="token plain"> hydrate</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="11-createfiberroot"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#11-createfiberroot"><span class="icon icon-link"></span></a>1.1 createFiberRoot</h3><p>生成<code>FiberRoot</code>和<code>RootFiber</code>,它们互相引用</p><blockquote><p>FiberRoot.current = RootFiber<br/>RootFiber.stateNode = FiberRoot</p></blockquote><ul><li>createFiberRoot</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token parameter">containerInfo</span><span class="token parameter punctuation">,</span><span class="token parameter"> isConcurrent</span><span class="token parameter punctuation">,</span><span class="token parameter"> hydrate</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> uninitializedFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token plain">isConcurrent</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableSchedulerTracing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> uninitializedFiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> containerInfo</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">earliestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">latestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">latestPingedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">didError</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">pendingCommitExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">finishedWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">timeoutHandle</span><span class="token operator">:</span><span class="token plain"> noTimeout</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">context</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">pendingContext</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      hydrate</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">nextExpirationTimeToWorkOn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">firstBatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">nextScheduledRoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">interactionThreadID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">unstable_getThreadID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">memoizedInteractions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">pendingInteractionMap</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> uninitializedFiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> containerInfo</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">earliestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">latestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">latestPingedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">didError</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">pendingCommitExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">finishedWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">timeoutHandle</span><span class="token operator">:</span><span class="token plain"> noTimeout</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">context</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">pendingContext</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      hydrate</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">nextExpirationTimeToWorkOn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">firstBatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">nextScheduledRoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  uninitializedFiber</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>createHostRootFiber</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token parameter">isConcurrent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> mode </span><span class="token operator">=</span><span class="token plain"> isConcurrent </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">ConcurrentMode</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">StrictMode</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">NoContext</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableProfilerTimer </span><span class="token operator">&amp;&amp;</span><span class="token plain"> isDevToolsPresent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    mode </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">ProfileMode</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">createFiber</span><span class="token punctuation">(</span><span class="token maybe-class-name">HostRoot</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> mode</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>createFiber</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">createFiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token parameter punctuation">,</span><span class="token parameter"> pendingProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> key</span><span class="token parameter punctuation">,</span><span class="token parameter"> mode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">FiberNode</span><span class="token punctuation">(</span><span class="token plain">tag</span><span class="token punctuation">,</span><span class="token plain"> pendingProps</span><span class="token punctuation">,</span><span class="token plain"> key</span><span class="token punctuation">,</span><span class="token plain"> mode</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>FiberNode</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">FiberNode</span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token parameter punctuation">,</span><span class="token parameter"> pendingProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> key</span><span class="token parameter punctuation">,</span><span class="token parameter"> mode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> tag</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">key</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> key</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">index</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">ref</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> pendingProps</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">firstContextDependency</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> mode</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoEffect</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">childExpirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableProfilerTimer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">actualDuration</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">actualStartTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">selfBaseDuration</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">treeBaseDuration</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>Fiber</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">WorkTag</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> string</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">sibling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter literal-property property">handle</span><span class="token parameter operator">:</span><span class="token parameter"> mixed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">_stringRef</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain">string</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">RefObject</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ContextDependency</span><span class="token operator">&lt;</span><span class="token plain">mixed</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">TypeOfMode</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">SideEffectTag</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">childExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ExpirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  actualDuration</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  actualStartTime</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  selfBaseDuration</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  treeBaseDuration</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _debugID</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _debugSource</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Source</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _debugOwner</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _debugIsCurrentlyTiming</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> boolean</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><h2 id="2更新渲染-root-节点"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#2更新渲染-root-节点"><span class="icon icon-link"></span></a>2.更新渲染 root 节点</h2><ul><li>unbatchedUpdates</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isBatchingUpdates </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">isUnbatchingUpdates</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    isUnbatchingUpdates </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//流程2：执行anonymous</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">finally</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      isUnbatchingUpdates </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token plain">a</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>ReactRoot.prototype.render</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token class-name">ReactRoot</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">//流程3：执行React.render</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  children</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callback </span><span class="token comment">// undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> work </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ReactWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">DOMRenderer</span><span class="token punctuation">.</span><span class="token method function property-access">updateContainer</span><span class="token punctuation">(</span><span class="token plain">children</span><span class="token punctuation">,</span><span class="token plain"> root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> work</span><span class="token punctuation">.</span><span class="token property-access">_onCommit</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> work</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>updateContainer</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 参数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token literal-property property">container</span><span class="token operator">:</span><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">context</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">current</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">didError</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">earliestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">finishedWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstBatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">hydrate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">interactionThreadID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestPingedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedInteractions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Set</span><span class="token punctuation">(</span><span class="token parameter number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextExpirationTimeToWorkOn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextScheduledRoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingCommitExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingContext</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingInteractionMap</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Map</span><span class="token punctuation">(</span><span class="token parameter number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">timeoutHandle</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  element</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  parentComponent</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callback</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> currentTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> expirationTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span><span class="token plain">currentTime</span><span class="token punctuation">,</span><span class="token plain"> current</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    element</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    parentComponent</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    expirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    callback</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>updateContainerAtExpirationTime</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateContainerAtExpirationTime</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  element</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  container</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  parentComponent</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  expirationTime</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callback</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getContextForSubtree</span><span class="token punctuation">(</span><span class="token plain">parentComponent</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">.</span><span class="token property-access">context</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">.</span><span class="token property-access">context</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> context</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    container</span><span class="token punctuation">.</span><span class="token property-access">pendingContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> context</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> element</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>scheduleRootUpdate</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">actualDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">actualStartTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">childExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">selfBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">sibling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">treeBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">_debugID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">_debugIsCurrentlyTiming</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">_debugOwner</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token literal-property property">_debugSource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">scheduleRootUpdate</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  element</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  expirationTime</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  callback</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token plain">expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 1.创建更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  update</span><span class="token punctuation">.</span><span class="token property-access">payload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> element </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  callback </span><span class="token operator">=</span><span class="token plain"> callback </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> callback</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">callback </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> callback</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> update</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 2.将更新放进更新队列，将更新队列绑定到fiber上,也就是current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">scheduleWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">// 3.调用scheduleWork进行更新调度</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="21-创建更新"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#21-创建更新"><span class="icon icon-link"></span></a>2.1 创建更新</h3><h3 id="22-将生成的更新放入更新队列"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#22-将生成的更新放入更新队列"><span class="icon icon-link"></span></a>2.2 将生成的更新放入更新队列</h3><ul><li>scheduleWork:进行调度更新 给 fiber（current）设置优先级（expirationTime），然后调用<code>requestWork</code></li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">scheduleWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  fiber</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  expirationTime </span><span class="token comment">// 1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">scheduleWorkToRoot</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//1.获取当前更新的root节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">markPendingPriorityLevel</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//2.将该root加入更新链表</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">isWorking </span><span class="token operator">||</span><span class="token plain"> isCommitting </span><span class="token operator">||</span><span class="token plain"> nextRoot </span><span class="token operator">!==</span><span class="token plain"> root</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> rootExpirationTime </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">requestWork</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> rootExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>requestWork</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">root</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">context</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">didError</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">earliestPendingTime</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">earliestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">expirationTime</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">finishedWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstBatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">hydrate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">interactionThreadID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">latestPendingTime</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestPingedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedInteractions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Set</span><span class="token punctuation">(</span><span class="token parameter number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">nextExpirationTimeToWorkOn</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextScheduledRoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingCommitExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingContext</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingInteractionMap</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Map</span><span class="token punctuation">(</span><span class="token parameter number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">timeoutHandle</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">requestWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  expirationTime </span><span class="token comment">// 1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">addRootToSchedule</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//同步更新</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>performSyncWork</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performSyncWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">performWork</span><span class="token punctuation">(</span><span class="token maybe-class-name">Sync</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>performWork</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  minExpirationTime</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  dl</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  deadline </span><span class="token operator">=</span><span class="token plain"> dl</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextFlushedRoot </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextFlushedExpirationTime </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">minExpirationTime </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      minExpirationTime </span><span class="token operator">&gt;=</span><span class="token plain"> nextFlushedExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain">nextFlushedRoot</span><span class="token punctuation">,</span><span class="token plain"> nextFlushedExpirationTime</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">findHighestPriorityRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  deadline </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  deadlineDidExpire </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">finishRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>performWorkOnRoot</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">root</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">context</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">didError</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">earliestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">finishedWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstBatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">hydrate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">interactionThreadID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestPingedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">latestSuspendedTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedInteractions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Set</span><span class="token punctuation">(</span><span class="token parameter number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextExpirationTimeToWorkOn</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">nextScheduledRoot</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingCommitExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingContext</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingInteractionMap</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Map</span><span class="token punctuation">(</span><span class="token parameter number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">timeoutHandle</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  root</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  expirationTime</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isExpired </span><span class="token comment">//true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isRendering </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> finishedWork </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> timeoutHandle </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">timeoutHandle</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> isYieldy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"> </span><span class="token comment">//可中断</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">renderRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> isYieldy</span><span class="token punctuation">,</span><span class="token plain"> isExpired</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  finishedWork </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">completeRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  isRendering </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="23-中断"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#23-中断"><span class="icon icon-link"></span></a>2.3 中断</h3><ul><li>renderRoot</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">renderRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isYieldy</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isExpired </span><span class="token comment">//true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isWorking </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentOwner</span><span class="token punctuation">.</span><span class="token property-access">currentDispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatcher</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> expirationTime </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">nextExpirationTimeToWorkOn</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resetStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  nextRoot </span><span class="token operator">=</span><span class="token plain"> root</span></div><div class="token-line"><span class="token plain">  nextRenderExpirationTime </span><span class="token operator">=</span><span class="token plain"> expirationTime</span></div><div class="token-line"><span class="token plain">  nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createWorkInProgress</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextRoot</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextRenderExpirationTime</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">pendingCommitExpirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableSchedulerTracing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> interactions </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root</span><span class="token punctuation">.</span><span class="token property-access">pendingInteractionMap</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">(</span><span class="token parameter">scheduledInteractions</span><span class="token parameter punctuation">,</span><span class="token parameter"> scheduledExpirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">scheduledExpirationTime </span><span class="token operator">&lt;=</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          scheduledInteractions</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">interaction</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            interactions</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token plain">interaction</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    root</span><span class="token punctuation">.</span><span class="token property-access">memoizedInteractions</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> interactions</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> prevInteractions</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableSchedulerTracing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    prevInteractions </span><span class="token operator">=</span><span class="token plain"> __interactionsRef</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    __interactionsRef</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">memoizedInteractions</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> didFatal </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">startWorkLoopTimer</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token plain">isYieldy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">//循环所有节点</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">thrownValue</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">break</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableSchedulerTracing</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    __interactionsRef</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> prevInteractions</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  isWorking </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentOwner</span><span class="token punctuation">.</span><span class="token property-access">currentDispatcher</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resetContextDependences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> didCompleteRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">stopWorkLoopTimer</span><span class="token punctuation">(</span><span class="token plain">interruptedBy</span><span class="token punctuation">,</span><span class="token plain"> didCompleteRoot</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> rootWorkInProgress </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  nextRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  interruptedBy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> rootWorkInProgress</span><span class="token punctuation">,</span><span class="token plain"> expirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>workLoop</li><li>如果不可中断，一直执行到为空为止</li><li>可中断，根据浏览器空运事件执行 performUnitOfWork</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  isYieldy </span><span class="token comment">//false,可中断</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">isYieldy</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="24-创建子节点和兄弟节点"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#24-创建子节点和兄弟节点"><span class="icon icon-link"></span></a>2.4 创建子节点和兄弟节点</h3><h3 id="25-标识更新节点"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#25-标识更新节点"><span class="icon icon-link"></span></a>2.5 标识更新节点</h3><ul><li>performUnitOfWork1</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualStartTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">childExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">selfBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">sibling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">treeBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">firstUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">lastUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">firstCapturedUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">lastCapturedUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugIsCurrentlyTiming</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugOwner</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugSource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">startWorkTimer</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> next</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableProfilerTimer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">ProfileMode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">stopProfilerTimerIfRunningAndRecordDelta</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentOwner</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> next</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>beginWork1</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualStartTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">childExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">expirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">selfBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">sibling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">treeBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">firstUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">lastUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">firstCapturedUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">lastCapturedUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugIsCurrentlyTiming</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugOwner</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugSource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  current</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderExpirationTime </span><span class="token comment">//1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updateExpirationTime </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>updateHostRoot</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualStartTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">childExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">expirationTime</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">selfBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">sibling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">containerInfo</span><span class="token operator">:</span><span class="token plain"> div#root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">pendingChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">earliestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">latestPendingTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">treeBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">firstUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">lastUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">firstCapturedUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">lastCapturedUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugIsCurrentlyTiming</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugOwner</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugSource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  current</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderExpirationTime</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">pushHostRootContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> updateQueue </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> nextProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> prevState </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> prevChildren </span><span class="token operator">=</span><span class="token plain"> prevState </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> prevState</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">processUpdateQueue</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    updateQueue</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    nextProps</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    renderExpirationTime</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> nextState </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> nextChildren </span><span class="token operator">=</span><span class="token plain"> nextState</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextChildren</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">resetHydrationState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>performUnitOfWork2</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">workInProgress</span><span class="token template-string template-punctuation string">`</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> ƒ</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> ƒ</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Local</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">current$$1</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">next</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">this</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">workInProgress</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> ƒ</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> ƒ</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Closure</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Closure</span><span class="token template-string template-punctuation string">`</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token plain">node_modules</span><span class="token operator">/</span><span class="token plain">react</span><span class="token operator">-</span><span class="token plain">dom</span><span class="token operator">/</span><span class="token plain">cjs</span><span class="token operator">/</span><span class="token plain">react</span><span class="token operator">-</span><span class="token plain">dom</span><span class="token punctuation">.</span><span class="token property-access">development</span><span class="token punctuation">.</span><span class="token property-access">js</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Window</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Global</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">FiberNode</span><span class="token template-string template-punctuation string">`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualStartTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">alternate</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">childExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">effectTag</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">elementType</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> ƒ </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">expirationTime</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">pendingProps</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">return</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">selfBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">sibling</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">stateNode</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">tag</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">treeBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">type</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> ƒ </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">updateQueue</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">_debugID</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">_debugIsCurrentlyTiming</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugOwner</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugSource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">workInProgress</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">startWorkTimer</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> next</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableProfilerTimer</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextRenderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">mode</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">ProfileMode</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token function">stopProfilerTimerIfRunningAndRecordDelta</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentOwner</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> next</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>beginWork2</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  current</span><span class="token punctuation">,</span><span class="token comment">//null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">,</span><span class="token comment">//同上</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderExpirationTime</span><span class="token punctuation">,</span><span class="token comment">//1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updateExpirationTime </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoWork</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">IndeterminateComponent</span><span class="token operator">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">var</span><span class="token plain"> elementType </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> elementType</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><h3 id="26-commitroot"><a aria-hidden="true" tabindex="-1" href="/web-react//3.source/2.react-dom/preparation#26-commitroot"><span class="icon icon-link"></span></a>2.6 commitRoot</h3><p>提交阶段</p><ul><li>mountIndeterminateComponent</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token literal-property property">workInProgress</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">actualStartTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">childExpirationTime</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">effectTag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> ƒ </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">expirationTime</span><span class="token template-string template-punctuation string">`</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstContextDependency</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberNode</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">…</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> …</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">selfBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">sibling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">treeBaseDuration</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> ƒ </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugID</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">4</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugIsCurrentlyTiming</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugOwner</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token literal-property property">_debugSource</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountIndeterminateComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _current</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//App</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  renderExpirationTime </span><span class="token comment">//1</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> unmaskedContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getUnmaskedContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> context </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getMaskedContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> unmaskedContext</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token function">prepareToReadContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> value</span></div><div class="token-line"><span class="token plain">  value </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Component</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">,</span><span class="token plain"> context</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">PerformedWork</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponent</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> value</span><span class="token punctuation">,</span><span class="token plain"> renderExpirationTime</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><ul><li>App</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain">hello</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p><img src="/web-react/static/1.1.53a2e048.png" alt=""/></p></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhoubichuan/web-react/edit/master/docs/3.source/2.react-dom/preparation.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">8/9/2022 05:25:40</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/web-react/umi.230947c1.js"></script>
  </body>
</html>
